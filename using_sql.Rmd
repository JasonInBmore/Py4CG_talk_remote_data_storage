---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
library(tidyverse)
library(mongolite)
library(odbc)
library(glue)
library(DBI)
library(mailR)



phoneitin <- dbConnect( odbc::odbc(),
                        driver = "ODBC Driver 17 for SQL Server",
                        Server = Sys.getenv("lme_ip"),
                        Database = "lme",
                        Uid = Sys.getenv("lme_id"),
                        Pwd = Sys.getenv("lme_pw") 
)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}

  weekly_df <- dbGetQuery(phoneitin,
                          glue("
                          SELECT 
quote_order.id AS quoteId,
RTRIM(quote_order.entered_user_id) AS Entered,
quote_order.effective_date AS effectiveDate,
quote_order.customer_id AS customerId,
quote_order.quote_status AS Status,
quote_order.salesperson_id AS salesRep

FROM quote_order

WHERE quote_order.revenue_code_id = 'DYLTL'
   AND quote_order.effective_date >= '{floor_date(yesterday, unit = 'week') - 7} 00:00:00' 
   AND quote_order.effective_date <= '{floor_date(yesterday, unit = 'week') - 1} 23:59:59' 
                       ")) 




dbRemoveTable(phoneitin, "real_recruiting_db") #remove old one

dbWriteTable(phoneitin, "real_recruiting_db", to_write, overwrite = TRUE)


  if(nrow(filtered_df)>0){
    dbWriteTable(phoneitin, "rate_model_reference_ETL", filtered_df, append = TRUE, overwrite =FALSE)
    message(paste("added", nrow(filtered_df),"rows"))
  }


update <- dbSendQuery(PM_MASTER, 'UPDATE test_table_update SET "A_Number"=?  WHERE ID=?')


tbl(PM_MASTER, 'test_table_update') %>% 
    filter(ID == 2) %>% 
    collect()


dbWriteTable(con, "mtcars", mtcars)
rs <- dbSendQuery(con, "SELECT * FROM mtcars WHERE cyl = 4;")
dbFetch(rs)
dbClearResult(rs)

dbDisconnect(con)


```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
